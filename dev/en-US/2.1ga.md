---
title: TiDB 2.1 GA Release Notes
category: Releases
---

# TiDB 2.1 GA Release Notes

2018 年 11 月 30 日，TiDB 发布 2.1 GA 版。相比 2.0 版本，该版本对系统稳定性、性能、兼容性、易用性做了大量改进。

## TiDB

+ SQL Optimizer

    - 优化 `Index Join` 选择范围，提升执行性能
    - 优化 `Index Join` 外表选择，使用估算的行数较少的表作为外表
    - 扩大 Join Hint `TIDB_SMJ` 的作用范围，在没有合适索引可用的情况下也可使用 Merge Join
    - 加强 Join Hint `TIDB_INLJ` 的能力，可以指定 Join 中的内表
    - Optimize correlated subquery, push down Filter, and extend the index selection range, to improve the efficiency of some queries by orders of magnitude
    - 支持在 `UPDATE` 和 `DELETE` 语句中使用 Index Hint 和 Join Hint
    - 支持更多函数下推：`ABS`/`CEIL`/`FLOOR`/`IS TRUE`/`IS FALSE`
    - 优化内建函数 `IF` 和 `IFNULL` 的常量折叠算法
    - 优化 `EXPLAIN` 语句输出格式, 使用层级结构表示算子之间的上下游关系

+ SQL Execution Engine

    - 重构所有聚合函数，提升 `Stream` 和 `Hash` 聚合算子的执行效率
    - 实现并行 `Hash Aggregate` 算子，部分场景下有 350% 的性能提升
    - 实现并行 `Project` 算子，部分场景有 74% 的性能提升
    - 并发地读取 `Hash Join` 的 `Inner` 表和 `Outer` 表的数据，提升执行性能
    - 优化 `REPLACE INTO` 语句的执行速度，性能提升 10x
    - Optimize the memory usage of the time data type and decrease the memory usage of the time data type by fifty percent
    - Optimize the point select performance and improve the point select efficiency result of Sysbench by 60%
    - Improve the performance of TiDB on inserting or updating wide tables by 20 times
    - Support configuring the memory upper limit of a single statement in the configuration file
    - 优化 `Hash Join` 的执行过程，当 Join 类型为 `Inner Join` 或者 `Semi Join` 时，如果内表为空，不再读取外表数据，快速返回结果
    - 支持 `EXPLAIN ANALYZE` 语句，用于查看 Query 执行过程中各个算子的运行时间，返回结果行数等运行时统计信息

+ 统计信息

    - Support enabling auto ANALYZE statistics only during certain period of the day
    - Support updating the table statistics automatically according to the feedback of the queries
    - 支持通过 `ANALYZE TABLE WITH BUCKETS` 语句配置直方图中桶的个数
    - Optimize the Row Count estimation algorithm using histogram for mixed queries of equality query and range queries

+ 表达式

    + 支持内建函数：

        - `json_contains`
        - `json_contains_path`
        - `encode/decode`

+ Server

    - Support queuing the locally conflicted transactions within tidb-server instance to optimize the performance of conflicted transactions
    - Support Server Side Cursor
    - 新增 HTTP 管理接口
    - Scatter the distribution of table Regions in the TiKV cluster
    - 控制是否打开 `general log`
    - Support modifying the log level online
    - Check the TiDB cluster information
    - 添加 `auto_analyze_ratio` 系统变量控制自动 Analyze 的阈值
    - 添加 `tidb_retry_limit` 系统变量控制事务自动重试的次数
    - 添加 `tidb_disable_txn_auto_retry` 系统变量控制事务是否自动重试
    - 支持使用 `admin show slow` 语句来获取慢查询语句
    - 增加环境变量 `tidb_slow_log_threshold` 动态设置 slow log 的阈值
    - 增加环境变量 `tidb_query_log_max_len` 动态设置日志中被截断的原始 SQL 语句的长度

+ DDL

    - Support the parallel execution of the Add index statement and other statements to avoid the time consuming Add index operation blocking other operations
    - 优化 `Add Index` 的速度，在某些场景下速度大幅提升
    - 支持 `select tidb_is_ddl_owner()` 语句，方便判断 TiDB 是否为 `DDL Owner`
    - 支持 `ALTER TABLE FORCE` 语法
    - 支持 `ALTER TABLE RENAME KEY TO` 语法
    - `Admin Show DDL Jobs` 输出结果中添加表名、库名等信息
    - 支持使用 `ddl/owner/resign` HTTP 接口释放 DDL Owner 并开启新一轮 DDL Owner 选举

+ 兼容性

    - Support more MySQL syntaxes
    - `BIT` 聚合函数支持 `ALL` 参数
    - 支持 `SHOW PRIVILEGES` 语句
    - 支持 `LOAD DATA` 语句的 `CHARACTER SET` 语法
    - 支持 `CREATE USER` 语句的 `IDENTIFIED WITH` 语法
    - 支持 `LOAD DATA IGNORE LINES` 语句
    - `Show ProcessList` 语句返回更准确信息

## PD (Placement Driver)

+ 可用性优化

    - Introduce the version control mechanism and support rolling update of the cluster compatibly
    - PD 节点间开启 `Raft PreVote`，避免网络隔离后恢复时产生的重新选举
    - 开启 `raft learner` 功能，降低调度时出现宕机导致数据不可用的风险
    - TSO allocation is no longer affected by the system clock going backwards
    - 支持 `Region merge` 功能，减少元数据带来的开销

+ Scheduler Optimizations

    - Optimize the processing of Down Store to speed up making up replicas
    - Optimize the hotspot scheduler to improve its adaptability when traffic statistics information jitters
    - Optimize the start of Coordinator to reduce the unnecessary scheduling caused by restarting PD
    - Optimize the issue that Balance Scheduler schedules small Regions frequently
    - Optimize Region merge to consider the number of rows within the Region
    - Add more commands to control the scheduling policy
    - Improve PD simulator to simulate the scheduling scenarios

+ API 及运维工具

    - 新增 `GetPrevRegion` 接口，用于支持 TiDB reverse scan 功能
    - 新增 `BatchSplitRegion` 接口，用于支持 TiKV 快速 Region 分裂
    - 新增 `GCSafePoint` 接口，用于支持 TiDB 并发分布式 GC
    - 新增 `GetAllStores` 接口，用于支持 TiDB 并发分布式 GC
    + pd-ctl 新增：

        - Use statistics for Region split
        - 调用 `jq` 来格式化 JSON 输出
        - Check the Region information of the specified store
        - Check topN Region list sorted by versions
        - Check topN Region list sorted by size
        - More precise TSO encoding

    - pd-recover doesn't need to provide the max-replica parameter

+ 监控

    - 增加 `Filter` 相关的监控
    - Add metrics about etcd Raft state machine

+ 性能优化

    - Optimize the performance of Region heartbeat to reduce the memory overhead brought by heartbeats
    - Optimize the Region tree performance
    - Optimize the performance of computing hotspot statistics

## TiKV

+ Coprocessor

    - Add more built-in functions
    - Add Coprocessor `ReadPool` to improve the concurrency in processing the requests
    - Fix the time function parsing issue and the time zone related issues
    - Optimize the memory usage for pushdown aggregation computing

+ Transaction

    - Optimize the read logic and memory usage of MVCC to improve the performance of the scan operation and the performance of full table scan is 1 time better than that in TiDB 2.0
    - Fold the continuous Rollback records to ensure the read performance
    - 新增 `UnsafeDestroyRange` API 用于在 drop table/index 的情况下快速回收空间
    - Separate the GC module to reduce the impact on write
    - Add the upper bound support in the kv_scan command

+ Raftstore

    - Improve the snapshot writing process to avoid RocksDB stall
    - Add the `LocalReader` thread to process read requests and reduce the delay for read requests
    - 支持 `BatchSplit` 避免大量写入导致产生特别大的 Region
    - Support Region Split according to statistics to reduce the I/O overhead
    - Support Region Split according to the number of keys to improve the concurrency of index scan
    - Improve the Raft message process to avoid unnecessary delay brought by Region Split
    - 启用 `PreVote` 功能，减少网络隔离对服务的影响

+ 存储引擎

    - 修复 RocksDB `CompactFiles` 的 bug，可能影响 Lightning 导入的数据
    - Upgrade RocksDB to v5.15 to fix the possible issue of snapshot file corruption
    - 优化 `IngestExternalFile`，避免 flush 卡住写入的问题

+ tikv-ctl

    - Add the `ldb` command to diagnose RocksDB related issues
    - The compact command supports specifying whether to compact data in the bottommost level

## Tools

- Fast full import of large amounts of data: TiDB-Lightning
- Support new TiDB-Binlog

## 升级兼容性说明

+ TiDB 2.1 does not support downgrading to v2.0.x or earlier due to the adoption of the new storage engine
+ If you upgrade from TiDB 2.0.6 or earlier to TiDB 2.1, check if there is any ongoing DDL operation, especially the time consuming `Add Index` operation, because the DDL operations slow down the upgrading process. If there is ongoing DDL operation, wait for the DDL operation finishes and then roll update.
+ Parallel DDL is enabled in TiDB 2.1, so the clusters with TiDB version earlier than 2.0.1 cannot upgrade to 2.1 using rolling update. You can choose either of the following two options:

    - Stop the cluster and upgrade to 2.1 directly
    - Roll update to 2.0.1 or later 2.0.x versions, and then roll update to the 2.1 version
