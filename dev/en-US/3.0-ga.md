---
title: TiDB 3.0 GA Release Notes
category: Releases
---

# TiDB 3.0 GA Release Notes

发版日期：2019 年 6 月 28 日

TiDB 版本：3.0.0

TiDB Ansible 版本：3.0.0

## Overview

On June 28, 2019, TiDB 3.0 GA is released. The corresponding TiDB Ansible version is 3.0.0. Compared with TiDB 2.1, this release has greatly improved in the following aspects:

- 稳定性方面，显著提升了大规模集群的稳定性，集群支持 150+ 存储节点，300+TB 存储容量长期稳定运行。
- 易用性方面有显著的提升，降低用户运维成本，例如：标准化慢查询日志，制定日志文件输出规范，新增 `EXPLAIN ANALYZE`，SQL Trace 功能方便排查问题等。
- Performance. The performance of TiDB 3.0 is 4.5 times greater than TiDB 2.1 in TPC-C benchmarks, and over 1.5 times in Sysbench benchmarks. Thanks to the support for Views, TPC-H 50G Q15 can now run normally.
- 新功能方面增加了窗口函数、视图（**实验特性**）、分区表、插件系统、悲观锁（**实验特性**）、`SQL Plan Management` 等特性。

## TiDB

+ New Features
    - 新增 Window Function，支持所有 MySQL 8.0 中的窗口函数，包括 `NTILE`，`LEAD`，`LAG`、`PERCENT_RANK`、`NTH_VALUE`、`CUME_DIST`、`FIRST_VALUE`、`LAST_VALUE`、`RANK`、`DENSE_RANK`、`ROW_NUMBER` 函数
    - 新增 View 功能（**实验特性**）
    - 完善  Table Partition 功能：
        - Range Partition
        - Hash Partition
    - 新增插件系统，官方提供 IP 白名单（**企业版特性**），审记日志（**企业版特性**）等插件
    - 新增 `SQL Plan Management` 功能，通过绑定 SQL 执行计划确保查询的稳定性（**实验特性**）
+ SQL Optimizer
    - 优化`NOT EXISTS` 子查询，转化为 Anti Semi Join 提升性能
    - 优化 `Outer Join` 常量传播，新增 `Outer Join` 消除优化规则，避免无效计算，提升性能
    - 优化 `IN` 子查询，先聚合后执行 `Inner Join`，提升性能
    - Optimize Index Join to adapt to more scenarios
    - Improve the Partition Pruning optimization rule of Range Partition
    - 优化 `_tidb_rowid` 查询逻辑，避免全表扫描，提升性能
    - Match more prefix columns of the indexes when extracting access conditions of composite indexes if there are relevant columns in the filter to improve performance
    - Improve the accuracy of cost estimates by using order correlation between columns
    - 基于统计信息的贪心算法及动态规划算法改进了 `Join Order`，提升多表关联的执行速度
    - Support Skyline Pruning, with some rules to prevent the execution plan from relying too heavily on statistics to improve query stability
    - Improve the accuracy of row count estimation for single-column indexes with NULL values
    - 新增 `FAST ANALYZE`，通过在各个 Region 中随机采样避免全表扫描的方式提升统计信息收集性能
    - 新增单调递增的索引列增量 `Analyze` 功能，提升统计信息收集性能
    - 支持 `DO` 语句中使用子查询
    - Support using Index Join in transactions
    - 优化 `prepare`/`execute`，支持不带参数的 DDL 语句
    - 修改变量 `stats-lease` 值为 0 时系统的行为，使其自动加载统计
    - Support exporting historical statistics
    - Support the dump/load correlation of histograms
+ SQL Execution Engine
    - 优化日志输出，`EXECUTE` 语句输出用户变量，`COMMIT` 语句输出慢查询日志，方便排查问题
    - 新增 `EXPLAIN ANALYZE` 功能，提升SQL 调优易用性
    - 新增 `admin show next_row_id` 功能，方便获取下一行 ID
    - 新增 `JSON_QUOTE`、`JSON_ARRAY_APPEND`、`JSON_MERGE_PRESERVE`、`BENCHMARK`、`COALESCE`、`NAME_CONST` 6 个内建函数
    - Optimize control logics on the chunk size to dynamically adjust based on the query context, to reduce the SQL execution time and resource consumption
    - 新增 `TableReader`、`IndexReader` 和 `IndexLookupReader` 算子内存追踪控制
    - 优化 Merge Join 算子，使其支持空的 `ON` 条件
    - Optimize write performance for single tables that contains too many columns
    - 通过支持逆序扫数据提升 `admin show ddl jobs` 的性能
    - 新增 `split table region` 语句，手动分裂表的 Region，缓解热点问题
    - 新增 `split index region` 语句，手动分裂索引的 Region，缓解热点问题
    - Add a blacklist to prohibit pushing down expressions to Coprocessor
    - Optimize the Expensive Query log to print the SQL query in the log when it exceeds the configured limit of execution time or memory
+ DDL
    - 支持字符集从 `utf8` 转换到 `utf8mb4` 的功能
    - 修改默认字符集从 `utf8` 变为 `utf8mb4`
    - 新增 `alter schema` 语句修改数据库 charset 和 collation 功能
    - 新增 ALTER ALGORITHM `INPLACE`/`INSTANT` 功能
    - 新增 `SHOW CREATE VIEW` 功能
    - 新增 `SHOW CREATE USER` 功能
    - Support fast recovery of mistakenly deleted tables
    - 新增动态调整 `ADD INDEX` 的并发数功能
    - 新增 pre_split_regions 选项，在 `CREATE TABLE` 时预先分配 Region，缓解建表后大量写入造成的写热点问题
    - Support splitting Regions by the index and range of the table specified using SQL statements to relieve hotspot issues
    - 新增 `ddl_error_count_limit` 全局变量，控制 DDL 任务重次数
    - 新增列属性包含 `AUTO_INCREMENT` 时利用 `SHARD_ROW_ID_BITS` 打散行 ID 功能，缓解热点问题
    - Optimize the invalid survival time of DDL metadata to shorten the period during which the DDL operation is slower after cluster upgrade
+ 事务
    - 新增悲观事务模型（**实验特性**）
    - 优化事务处理逻辑，适应更多场景，具体如下：
        - `tidb_disable_txn_auto_retry` 的默认值为 `on` ，即不会重试非自动提交的事务
        - 新增 `tidb_batch_commit` 系统变量控制将事务拆分成多个事务并发执行
        - 新增 `tidb_low_resolution_tso` 系统变量控制批量获取 `tso` 个数，减少事务获取 `tso` 的次数以适应某些数据一致性要求较低的场景
        - 新增 `tidb_skip_isolation_level_check` 变量控制事务检查隔离级别设置为 SERIALIZABLE 时是否报错
        - 修改 `tidb_disable_txn_auto_retry` 系统变量的行为，修改为影响所有的可重试错误
+ Privilege Management
        - 对 `ANALYZE`、`USE`、`SET GLOBAL`、`SHOW PROCESSLIST` 语句进行权限检查
        - 新增基于角色的权限访问控制功能 (RBAC)（**实验特性**）
+ Server
    - 优化慢查询日志，具体包括：
        - Restructure the log format
        - Optimize the log content
        - 优化查询慢查询日志的方法，通过内存表 `INFORMATION_SCHEMA.SLOW_QUERY`，`ADMIN SHOW SLOW` 语句查询慢查询日志
    - Develop a unified log format specification with restructured log system to facilitate collection and analysis by tools
    - Support using SQL statements to manage TiDB Binlog services, including querying status, enabling TiDB Binlog, maintaining and sending TiDB Binlog strategies.
    - 新增通过 `unix_socket` 方式连接数据库
    - 新增 SQL 语句 `Trace` 功能
    - 新增 `/debug/zip` HTTP 接口，获取 TiDB 实例的信息，方便排查问题
    - 优化监控项，方便排查问题，如下：
        - 新增 `high_error_rate_feedback_total` 监控项，监控真实数据量与统计信息估算数据量之间的差距
        - Add a QPS monitoring item in the database dimension
    - Optimize the system initialization process to only allow the DDL owner to perform the initialization. This reduces the startup time for initialization or upgrading.
    - 优化 `kill query` 语句执行逻辑，提升性能，确保资源正确释放
    - 新增启动选项 `config-check` 检查配置文件合法性
    - 新增 `tidb_back_off_weight` 系统变量，控制内部出错重试的退避时间
    - 新增 `wait_timeout`、`interactive_timeout` 系统变量，控制连接空闲超过变量的值，系统自动断开连接。
    - Add the connection pool for TiKV to shorten the connection establishing time
+ 兼容性
    - 支持 `ALLOW_INVALID_DATES` SQL mode
    - Support the MySQL 320 Handshake protocol
    - Support using the unsigned bigint column as the auto-increment column
    - 支持 `SHOW CREATE DATABASE IF NOT EXISTS` 语法
    - Optimize the fault tolerance of load data for CSV files
    - Abandon the predicate pushdown operation when the filtering condition contains a user variable to improve the compatibility with MySQL’s behavior of using user variables to simulate Window Functions

## PD

- Support re-creating a cluster from a single node
- Migrate Region metadata from etcd to the go-leveldb storage engine to solve the storage bottleneck in etcd for large-scale clusters

+ API
    - 新增 `remove-tombstone` 接口，用于清理 Tombstone Store
    - 新增 `ScanRegions` 接口，用于批量查询 Region 信息
    - 新增 `GetOperator` 接口，用于查询运行中的 Operator
    - 优化 `GetStores` 接口的性能
+ 配置
    - Optimize configuration check logic to avoid configuration item errors
    - 新增 `enable-two-way-merge`，用于控制 Region merge 的方向
    - 新增 `hot-region-schedule-limit`，用于控制热点 Region 调度速度
    - 新增 `hot-region-cache-hits-threshold`，连续命中阀值用于判断热点
    - 新增 `store-balance-rate` 配置，用于控制每分钟产生 balance Region Operator 数量的上限
+ Scheduler Optimizations
    - Add the store limit mechanism for separately controlling the speed of operators for each store
    - 添加 `waitingOperator` 队列，用于优化不同调度器之间资源竞争的问题
    - Support scheduling rate limit to actively send scheduling operations to TiKV. This improves the scheduling rate by limiting the number of concurrent scheduling tasks on a single node.
    - Optimize the Region Scatter scheduling to be not restrained by the limit mechanism
    - 新增 `shuffle-hot-region` 调度器，解决稳定性测试易用性问题
+ Simulator
    - Add simulator for data import scenarios
    - Support setting different heartbeats intervals for the Store
+ 其他
    - Upgrade etcd to solve the issues of inconsistent log output formats, Leader selection failure in prevote, and lease deadlocking
    - Develop a unified log format specification with restructured log system to facilitate collection and analysis by tools
    - Add monitoring metrics including scheduling parameters, cluster label information, time consumed by PD to process TSO requests, Store ID and address information, etc.

## TiKV

- Support distributed GC and concurrent lock resolving for improved GC performance
- 新增逆向 `raw_scan` 和 `raw_batch_scan` 功能
- Support Multi-thread Raftstore and Multi-thread Apply to improve scalabilities, concurrency capacity, and resource usage within a single node. Performance improves by 70% under the same level of pressure
- Support batch receiving and sending Raft messages, improving TPS by 7% for write intensive scenarios
- Support checking RocksDB Level 0 files before applying snapshots to avoid write stall
- 新增 Titan 存储引擎插件，提升 Value 超过 1KiB 时系统的性能，一定程度上缓解写放大问题（**实验特性**）
- 新增悲观事务模型（**实验特性**）
- Support getting monitoring information via HTTP
- Modify the semantics of Insert to allow Prewrite to succeed only when there is no Key
- Develop a unified log format specification with restructured log system to facilitate collection and analysis by tools
- Add performance metrics related to configuration information and key bound crossing
- Support Local Reader in RawKV to improve performance

+ Engine
    - 优化内存管理，减少 `Iterator Key Bound Option` 的内存分配和拷贝，提升性能
    - Support block cache sharing among different column families
+ Server
    - 优化 `batch commands` 的上下文切换开销，提升性能
    - Remove txn scheduler
    - Add monitoring items related to read index and GC worker
+ RaftStore
    - 新增 hibernate Regions 功能，优化 RaftStore CPU 的消耗（**实验特性**）
    - Remove the local reader thread
+ Coprocessor
    - Refactor the computation framework to implement vector operators, computation using vector expressions, and vector aggregations to improve performance
    - 支持为 TiDB `EXPLAIN ANALYZE` 语句提供算子执行详情
    - Switch to the work-stealing thread pool model to reduce context switch cost

## Tools

+ TiDB Lightning
    - Support redirected replication of data tables
    - Support importing CSV files
    - Improve performance for conversion from SQL to KV pairs
    - Support batch import of single tables to improve performance
    - 支持将大表的数据和索引分别导入，提升 `TiKV-Importer` 导入数据性能
    - Support filling the missing column using the row_id or the default column value when column data is missing in the new file
    - `TiKV-Importer` 支持对 upload SST 到 TiKV 限速功能
+ TiDB Binlog
    - Drainer 新增 `advertise-addr` 配置，支持容器环境中使用桥接模式
    - Add the GetMvccByEncodeKey function in Pump to speed up querying the transaction status
    - Support compressing communication data among components to reduce network resource consumption
    - Add the Arbiter tool that supports reading binlog from Kafka and replicate the data into MySQL
    - Support filtering out files that don’t require replication via Reparo
    - Support replicating generated columns
    - Add the syncer.sql-mode configuration item to support using different sql-modes to parse DDL queries
    - Add the syncer.ignore-table configuration item to support filtering tables not to be replicated
+ sync-diff-inspector
    - Support checkpoint to record verification status and continue the verification from last saved point after restarting
    - Add the only-use-checksum configuration item to check data consistency by calculating checksum
    - Support using TiDB statistics and multiple columns to split chunks for comparison to adapt to more scenarios

## TiDB Ansible

- Upgrade the following monitoring components to a stable version:
    - Prometheus 从 2.2.1 升级到 2.8.1 版本
    - Pushgateway 从 0.4.0 升级到 0.7.0 版本
    - Node_exporter 从 0.15.2 升级到 0.17.0 版本
    - Alertmanager 从 0.14.0 升级到 0.17.0 版本
    - Grafana 从 4.6.3 升级到 6.1.6 版本
    - Ansible 从 2.5.14 升级到 2.7.11 版本
- Add the TiKV summary monitoring dashboard to view cluster status conveniently
- Add the TiKV trouble_shooting monitoring dashboard to remove duplicate items and facilitate troubleshooting
- Add the TiKV details monitoring dashboard to facilitate debugging and troubleshooting
- Add concurrent check for version consistency during rolling updates to improve the update performance
- Support deployment and operations for TiDB Lightning
- 优化 `table-regions.py` 脚本，新增按表显示 leader 分布功能
- Optimize TiDB monitoring with new panels that display latencies by SQL categories
- Modify the version limit for the operating system and only support CentOS 7.0 or later and Red Hat 7.0 or later
- Add the monitoring item to predict the maximum QPS of the cluster (hidden by default)
